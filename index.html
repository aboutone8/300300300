<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- æ”¾å®½CSPä»¥å…è®¸Phantomé’±åŒ…è¿æ¥ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline'; connect-src https://* wss://* http://localhost:*; img-src 'self' data:;">
    <title>å®˜æ–¹æ¸¸æˆå¹³å°</title>
    <!-- åŠ è½½Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.3.7/lib/index.iife.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --accent-color: #9945FF;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --banner-bg: #d32f2f;
            --banner-text: #ffeb3b;
            --text-light: #ffffff;
            --text-dark: #333333;
            --bg-light: #f5f5f5;
            --overlay-bg: rgba(0, 0, 0, 0.85);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow-x: hidden;
        }
        
        /* æ¨ªå¹…æ ·å¼ */
        .banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--banner-bg);
            color: var(--banner-text);
            font-weight: bold;
            padding: 10px 20px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 0.9rem;
            transition: transform 0.3s;
        }
        
        .banner-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--banner-text);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10000;
        }
        
        .banner-collapsed {
            transform: translateY(-100%);
        }
        
        .banner-info {
            margin: 5px 0;
        }
        
        .banner-wallet {
            font-family: monospace;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .copy-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 4px;
            color: var(--banner-text);
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 5px;
            padding: 2px 6px;
        }
        
        /* æ”¯ä»˜ç›¸å…³æ ·å¼ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .payment-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            width: 450px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        
        .payment-title {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--text-dark);
        }
        
        .payment-info {
            margin-bottom: 1.5rem;
            color: var(--text-dark);
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .wallet-status {
            background-color: rgba(0,0,0,0.1);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-family: monospace;
        }
        
        .payment-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            font-size: 1rem;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--text-light);
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: var(--text-light);
        }
        
        .btn-accent:hover:not(:disabled) {
            background-color: #8833ee;
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--text-dark);
            border: 1px solid #ccc;
        }
        
        .btn-outline:hover:not(:disabled) {
            background-color: rgba(0,0,0,0.05);
        }
        
        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* æ¸¸æˆé€‰æ‹©å™¨æ ·å¼ */
        .game-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            margin-top: 60px;
        }
        
        .game-selector-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--text-dark);
            text-align: center;
        }
        
        .game-options {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .game-option {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            width: 250px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .game-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .game-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
        }
        
        .game-name {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }
        
        .game-description {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        /* æ¸¸æˆå®¹å™¨æ ·å¼ */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            padding-top: 60px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin-bottom: 1rem;
            padding: 0 1rem;
        }
        
        .back-button {
            padding: 0.5rem 1rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .back-button:hover {
            background-color: #8833ee;
        }
        
        .game-canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 600px;
            margin: 0 auto;
        }
        
        canvas {
            display: block;
            background-color: black;
            width: 100%;
            height: 100%;
        }
        
        /* æ¶ˆæ¯é€šçŸ¥æ ·å¼ */
        .message-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 10000;
        }
        
        .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            color: white;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateX(50px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 300px;
        }
        
        .message.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .message-success {
            background-color: var(--primary-color);
        }
        
        .message-error {
            background-color: var(--danger-color);
        }
        
        .message-warning {
            background-color: var(--warning-color);
            color: var(--text-dark);
        }
        
        .message-info {
            background-color: #2196F3;
        }
        
        /* é€šç”¨ç±» */
        .hidden {
            display: none !important;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .game-options {
                flex-direction: column;
                gap: 1rem;
            }
            
            .game-option {
                width: 100%;
                max-width: 280px;
            }
            
            .game-canvas-container {
                height: 450px;
            }
            
            .payment-box {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .banner {
                font-size: 0.8rem;
                padding: 8px 30px 8px 8px;
            }
            
            .game-selector-title {
                font-size: 1.5rem;
            }
            
            .game-canvas-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ¨ªå¹… -->
    <div id="officialBanner" class="banner">
        <div class="banner-info">å®˜æ–¹åªæ¥å—Solanaé“¾ä¸Šçš„USDCä»£å¸æ”¯ä»˜</div>
        <div class="banner-info">å®˜æ–¹é’±åŒ…åœ°å€: <span class="banner-wallet">AXf8wCy3WawqZZtZh4Jix2PRDJdDu4xdymR6HuD1ot8H</span>
            <button class="copy-btn" id="copyWalletBtn">å¤åˆ¶</button>
        </div>
    </div>
    <button id="bannerToggle" class="banner-toggle">â–²</button>
    
    <!-- æ”¯ä»˜å å±‚ -->
    <div id="paymentOverlay" class="overlay">
        <div class="payment-box">
            <h2 class="payment-title">è¯·ä»˜è´¹å¼€å§‹æ¸¸æˆ</h2>
            <p class="payment-info">è¯·ä½¿ç”¨Phantomé’±åŒ…æ”¯ä»˜1æšSolanaé“¾ä¸Šçš„USDCä»£å¸ä»¥å¼€å§‹æ¸¸æˆã€‚æ‰€æœ‰ä»˜è´¹å°†è‡ªåŠ¨å¤„ç†ã€‚</p>
            
            <div id="walletStatus" class="wallet-status">æœªè¿æ¥é’±åŒ…</div>
            
            <div id="loadingSpinner" class="loading-spinner hidden"></div>
            
            <div class="payment-actions">
                <button id="connectWalletBtn" class="btn btn-accent">è¿æ¥é’±åŒ…</button>
                <button id="payButton" class="btn btn-primary" disabled>æ”¯ä»˜1 USDC</button>
                <button id="manualVerifyBtn" class="btn btn-outline">æˆ‘å·²å®Œæˆä»˜æ¬¾(æ‰‹åŠ¨éªŒè¯)</button>
            </div>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯é€šçŸ¥å®¹å™¨ -->
    <div id="messageContainer" class="message-container"></div>
    
    <!-- æ¸¸æˆé€‰æ‹©å™¨ -->
    <div id="gameSelectorContainer" class="game-selector hidden">
        <h1 class="game-selector-title">è¯·é€‰æ‹©æ¸¸æˆ</h1>
        <div class="game-options">
            <div id="planeGameOption" class="game-option">
                <div class="game-icon">âœˆï¸</div>
                <h2 class="game-name">é£æœºå¤§æˆ˜</h2>
                <p class="game-description">æ§åˆ¶é£æœºèº²é¿æ•Œäººï¼Œå°½å¯èƒ½è·å¾—é«˜åˆ†</p>
            </div>
            <div id="marbleGameOption" class="game-option">
                <div class="game-icon">ğŸ”®</div>
                <h2 class="game-name">å¼¹ç æ¸¸æˆ</h2>
                <p class="game-description">æ§åˆ¶å¼¹ç é€šè¿‡å„ç§å…³å¡éšœç¢</p>
            </div>
        </div>
    </div>
    
    <!-- é£æœºæ¸¸æˆå®¹å™¨ -->
    <div id="planeGameContainer" class="game-container hidden">
        <div class="game-header">
            <button id="backToSelector" class="back-button">è¿”å›é€‰æ‹©</button>
        </div>
        <div class="game-canvas-container">
            <canvas id="planeGameCanvas"></canvas>
        </div>
    </div>
    
    <!-- å¼¹ç æ¸¸æˆå®¹å™¨ -->
    <div id="marbleGameContainer" class="game-container hidden">
        <div class="game-header">
            <button id="backToSelectorMarble" class="back-button">è¿”å›é€‰æ‹©</button>
        </div>
        <div class="game-canvas-container">
            <canvas id="marbleGameCanvas"></canvas>
        </div>
        <div id="winText" class="hidden">èƒœåˆ©!</div>
    </div>
    
    <script>
        // è¾…åŠ©å·¥å…·å¯¹è±¡
        const Helpers = {
            // æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥
            showMessage: function(message, type = 'info', duration = 3000) {
                console.log(`æ˜¾ç¤ºæ¶ˆæ¯: ${message}, ç±»å‹: ${type}`);
                const container = document.getElementById('messageContainer');
                const msgElement = document.createElement('div');
                msgElement.className = `message message-${type}`;
                msgElement.innerHTML = message;
                
                container.appendChild(msgElement);
                
                // çŸ­å»¶è¿Ÿåæ˜¾ç¤ºï¼ˆå…è®¸CSSè¿‡æ¸¡ï¼‰
                setTimeout(() => {
                    msgElement.classList.add('show');
                }, 10);
                
                // å¦‚æœè®¾ç½®äº†æŒç»­æ—¶é—´ï¼Œåˆ™åœ¨ä¹‹ååˆ é™¤æ¶ˆæ¯
                if (duration > 0) {
                    setTimeout(() => {
                        msgElement.classList.remove('show');
                        
                        // ç­‰å¾…è¿‡æ¸¡å®Œæˆåç§»é™¤å…ƒç´ 
                        setTimeout(() => {
                            container.removeChild(msgElement);
                        }, 300);
                    }, duration);
                }
                
                return msgElement;
            },
            
            // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
            copyToClipboard: function(text) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        this.showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    })
                    .catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥: ', err);
                        this.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                    });
            },
            
            // ç”Ÿæˆå”¯ä¸€ID
            generateUniqueId: function() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }
        };
        
        // Solanaé’±åŒ…ç®¡ç†å™¨
        const WalletManager = {
            walletConnected: false,
            publicKey: null,
            connection: null,
            phantom: null,
            
            // RPCèŠ‚ç‚¹åˆ—è¡¨
            rpcEndpoints: [
                'https://api.mainnet-beta.solana.com',
                'https://solana-api.projectserum.com',
                'https://rpc.ankr.com/solana'
            ],
            
            // USDC Token Mintåœ°å€ï¼ˆSolanaä¸»ç½‘ï¼‰
            usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
            
            // æ”¯ä»˜é‡‘é¢ï¼ˆ1 USDC = 1,000,000ä¸ªæœ€å°å•ä½ï¼‰
            paymentAmount: 1000000,
            
            // æ”¶æ¬¾åœ°å€ - æ›¿æ¢ä¸ºæ‚¨çš„å®é™…Solanaé’±åŒ…åœ°å€
            payToAddress: 'AXf8wCy3WawqZZtZh4Jix2PRDJdDu4xdymR6HuD1ot8H',
            
            // ç®€åŒ–çš„åˆå§‹åŒ–æ–¹æ³•
            async initialize() {
                console.log("åˆå§‹åŒ–é’±åŒ…ç®¡ç†å™¨...");
                
                // è¿æ¥RPC
                await this.connectToRPC();
                
                // åˆå§‹åŒ–é’±åŒ…è¿æ¥æŒ‰é’®
                const connectWalletBtn = document.getElementById('connectWalletBtn');
                const payButton = document.getElementById('payButton');
                const manualVerifyBtn = document.getElementById('manualVerifyBtn');
                
                // æ£€æŸ¥Phantomé’±åŒ…æ˜¯å¦å¯ç”¨
                if (window.solana && window.solana.isPhantom) {
                    console.log("æ£€æµ‹åˆ°Phantomé’±åŒ…!");
                    this.phantom = window.solana;
                    connectWalletBtn.disabled = false;
                    
                    // è‡ªåŠ¨æ¢å¤å·²è¿æ¥çŠ¶æ€
                    if (this.phantom.isConnected) {
                        this.walletConnected = true;
                        this.publicKey = this.phantom.publicKey;
                        connectWalletBtn.textContent = 'é’±åŒ…å·²è¿æ¥';
                        connectWalletBtn.disabled = true;
                        payButton.disabled = false;
                        
                        document.getElementById('walletStatus').textContent = 
                            `å·²è¿æ¥: ${this.publicKey.toString().slice(0,4)}...${this.publicKey.toString().slice(-4)}`;
                        console.log("å·²è‡ªåŠ¨è¿æ¥åˆ°é’±åŒ…:", this.publicKey.toString());
                    }
                } else {
                    console.log("æœªæ£€æµ‹åˆ°Phantomé’±åŒ…");
                    connectWalletBtn.textContent = 'è¯·å®‰è£…Phantomé’±åŒ…';
                    connectWalletBtn.disabled = true;
                    Helpers.showMessage('è¯·å®‰è£…Phantomé’±åŒ…ä»¥ç»§ç»­<br><a href="https://phantom.app/" target="_blank" style="color:white;text-decoration:underline;">è·å–Phantom</a>', 'warning', 0);
                }
                
                // ä½¿ç”¨å†…è”å‡½æ•°ç»‘å®šäº‹ä»¶ï¼Œé¿å…thisæŒ‡å‘é—®é¢˜
                connectWalletBtn.onclick = async () => {
                    console.log("ç‚¹å‡»è¿æ¥é’±åŒ…æŒ‰é’®");
                    try {
                        await this.connectWallet();
                    } catch (err) {
                        console.error("è¿æ¥é’±åŒ…æ—¶å‡ºé”™:", err);
                        Helpers.showMessage('è¿æ¥é’±åŒ…å¤±è´¥: ' + err.message, 'error');
                    }
                };
                
                payButton.onclick = async () => {
                    try {
                        await this.makePayment();
                    } catch (err) {
                        console.error("æ”¯ä»˜æ—¶å‡ºé”™:", err);
                        Helpers.showMessage('æ”¯ä»˜å¤±è´¥: ' + err.message, 'error');
                        document.getElementById('loadingSpinner').classList.add('hidden');
                    }
                };
                
                manualVerifyBtn.onclick = async () => {
                    try {
                        await this.verifyPayment();
                    } catch (err) {
                        console.error("éªŒè¯æ—¶å‡ºé”™:", err);
                        Helpers.showMessage('éªŒè¯å¤±è´¥: ' + err.message, 'error');
                    }
                };
                
                console.log("é’±åŒ…ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ");
            },
            
            // è¿æ¥åˆ°RPCèŠ‚ç‚¹
            async connectToRPC() {
                console.log("å°è¯•è¿æ¥åˆ°RPCèŠ‚ç‚¹...");
                // å°è¯•æ‰€æœ‰RPCèŠ‚ç‚¹ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå·¥ä½œçš„
                for (const endpoint of this.rpcEndpoints) {
                    try {
                        console.log(`å°è¯•è¿æ¥åˆ° ${endpoint}...`);
                        const tempConnection = new solanaWeb3.Connection(endpoint, 'confirmed');
                        // æµ‹è¯•è¿æ¥æ˜¯å¦æœ‰æ•ˆ
                        await tempConnection.getLatestBlockhash()
                            .then(() => {
                                this.connection = tempConnection;
                                console.log('å·²è¿æ¥åˆ°SolanaèŠ‚ç‚¹:', endpoint);
                                return true;
                            })
                            .catch(err => {
                                console.warn(`æ— æ³•è¿æ¥åˆ° ${endpoint}:`, err);
                                return false;
                            });
                        
                        if (this.connection) break; // å¦‚æœæ‰¾åˆ°å¯ç”¨è¿æ¥ï¼Œè·³å‡ºå¾ªç¯
                    } catch (error) {
                        console.warn(`å°è¯•è¿æ¥åˆ° ${endpoint} æ—¶å‡ºé”™:`, error);
                    }
                }
                
                if (!this.connection) {
                    Helpers.showMessage('æ— æ³•è¿æ¥åˆ°Solanaç½‘ç»œï¼Œè¯·ç¨åå†è¯•', 'error');
                }
            },
            
            // ç®€åŒ–çš„é’±åŒ…è¿æ¥æ–¹æ³•
            async connectWallet() {
                console.log("å°è¯•è¿æ¥é’±åŒ…...");
                
                if (!window.solana || !window.solana.isPhantom) {
                    console.error("Phantomé’±åŒ…æœªå®‰è£…");
                    Helpers.showMessage('è¯·å®‰è£…Phantomé’±åŒ…åå†å°è¯•', 'error');
                    return;
                }
                
                try {
                    // ä½¿ç”¨ç›´æ¥çš„è¿æ¥æ–¹æ³•
                    const resp = await window.solana.connect();
                    console.log("é’±åŒ…è¿æ¥æˆåŠŸ:", resp);
                    
                    this.walletConnected = true;
                    this.publicKey = resp.publicKey;
                    this.phantom = window.solana;
                    
                    // æ›´æ–°UI
                    const connectBtn = document.getElementById('connectWalletBtn');
                    connectBtn.textContent = 'é’±åŒ…å·²è¿æ¥';
                    connectBtn.disabled = true;
                    
                    document.getElementById('payButton').disabled = false;
                    document.getElementById('walletStatus').textContent = 
                        `å·²è¿æ¥: ${this.publicKey.toString().slice(0,4)}...${this.publicKey.toString().slice(-4)}`;
                    
                    Helpers.showMessage('é’±åŒ…è¿æ¥æˆåŠŸ!', 'success');
                } catch (err) {
                    console.error("è¿æ¥é’±åŒ…å¤±è´¥:", err);
                    Helpers.showMessage(`è¿æ¥é’±åŒ…å¤±è´¥: ${err.message}`, 'error');
                }
            },
            
            // è¿›è¡ŒUSDCæ”¯ä»˜
            async makePayment() {
                if (!this.walletConnected) {
                    Helpers.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
                    return;
                }
                
                if (!this.connection) {
                    await this.connectToRPC();
                    if (!this.connection) {
                        Helpers.showMessage('æ— æ³•è¿æ¥åˆ°Solanaç½‘ç»œï¼Œè¯·ç¨åå†è¯•', 'error');
                        return;
                    }
                }
                
                try {
                    Helpers.showMessage('æ­£åœ¨å¤„ç†ä»˜æ¬¾...', 'info');
                    document.getElementById('loadingSpinner').classList.remove('hidden');
                    
                    // è·å–USDCä»£å¸è´¦æˆ·
                    const tokenAccounts = await this.connection.getParsedTokenAccountsByOwner(
                        this.publicKey,
                        { mint: new solanaWeb3.PublicKey(this.usdcMint) }
                    );
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰USDCè´¦æˆ·
                    if (tokenAccounts.value.length === 0) {
                        Helpers.showMessage('æ‚¨çš„é’±åŒ…ä¸­æ²¡æœ‰USDCä»£å¸è´¦æˆ·', 'error');
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        return;
                    }
                    
                    // è·å–ç”¨æˆ·çš„USDCè´¦æˆ·
                    const usdcAccount = tokenAccounts.value[0].pubkey;
                    const balance = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
                    
                    // æ£€æŸ¥ä½™é¢
                    if (balance < 1) {
                        Helpers.showMessage(`ä½™é¢ä¸è¶³ã€‚éœ€è¦1 USDCï¼Œä½†æ‚¨åªæœ‰ ${balance} USDC`, 'error');
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        return;
                    }
                    
                    // æ„å»ºæ”¶æ¬¾åœ°å€
                    const recipient = new solanaWeb3.PublicKey(this.payToAddress);
                    
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºæ¥æ”¶è€…çš„ATAï¼ˆå…³è”ä»£å¸è´¦æˆ·ï¼‰
                    const recipientATAs = await this.connection.getParsedTokenAccountsByOwner(
                        recipient,
                        { mint: new solanaWeb3.PublicKey(this.usdcMint) }
                    );
                    
                    let recipientTokenAccount;
                    
                    if (recipientATAs.value.length > 0) {
                        // ä½¿ç”¨ç°æœ‰çš„ATA
                        recipientTokenAccount = recipientATAs.value[0].pubkey;
                    } else {
                        // ä»å®‰å…¨è€ƒè™‘ï¼Œå¦‚æœæ”¶æ¬¾äººæ²¡æœ‰USDCè´¦æˆ·ï¼Œæˆ‘ä»¬å–æ¶ˆäº¤æ˜“
                        // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦åˆ›å»ºATA
                        Helpers.showMessage('æ”¶æ¬¾é’±åŒ…æ²¡æœ‰USDCè´¦æˆ·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        return;
                    }
                    
                    // åˆ›å»ºäº¤æ˜“æŒ‡ä»¤
                    const transferInstruction = splToken.Token.createTransferInstruction(
                        splToken.TOKEN_PROGRAM_ID,
                        usdcAccount,
                        recipientTokenAccount,
                        this.publicKey,
                        [],
                        this.paymentAmount
                    );
                    
                    const transaction = new solanaWeb3.Transaction().add(transferInstruction);
                    
                    // è®¾ç½®æœ€è¿‘çš„åŒºå—å“ˆå¸Œå’Œä»˜æ¬¾äºº
                    const { blockhash } = await this.connection.getRecentBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = this.publicKey;
                    
                    // å‘é€äº¤æ˜“
                    const signed = await this.phantom.signTransaction(transaction);
                    const signature = await this.connection.sendRawTransaction(signed.serialize());
                    
                    console.log("äº¤æ˜“å‘é€æˆåŠŸ:", signature);
                    
                    // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                    Helpers.showMessage('äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                    
                    const result = await this.connection.confirmTransaction(signature, 'confirmed');
                    
                    if (result.value.err) {
                        Helpers.showMessage('äº¤æ˜“å¤±è´¥: ' + result.value.err, 'error');
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        return;
                    }
                    
                    console.log("äº¤æ˜“å·²ç¡®è®¤:", result);
                    document.getElementById('loadingSpinner').classList.add('hidden');
                    
                    // æ”¯ä»˜æˆåŠŸï¼Œéšè—æ”¯ä»˜å å±‚å¹¶æ˜¾ç¤ºæ¸¸æˆé€‰æ‹©å™¨
                    Helpers.showMessage('æ”¯ä»˜æˆåŠŸ! æ¸¸æˆå·²è§£é”', 'success');
                    document.getElementById('paymentOverlay').classList.add('hidden');
                    document.getElementById('gameSelectorContainer').classList.remove('hidden');
                    
                } catch (error) {
                    console.error("æ”¯ä»˜è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", error);
                    Helpers.showMessage('æ”¯ä»˜å¤±è´¥: ' + error.message, 'error');
                    document.getElementById('loadingSpinner').classList.add('hidden');
                }
            },
            
            // æ‰‹åŠ¨éªŒè¯æ”¯ä»˜ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
            async verifyPayment() {
                // è¿™é‡Œæˆ‘ä»¬ç®€å•åœ°æ˜¾ç¤ºæ¸¸æˆé€‰æ‹©å™¨ï¼Œç›¸å½“äºç»•è¿‡äº†æ”¯ä»˜éªŒè¯
                // å®é™…åº”ç”¨ä¸­åº”è¯¥æœ‰çœŸæ­£çš„éªŒè¯æœºåˆ¶
                Helpers.showMessage('å·²éªŒè¯æ”¯ä»˜ï¼Œæ¸¸æˆå·²è§£é”', 'success');
                document.getElementById('paymentOverlay').classList.add('hidden');
                document.getElementById('gameSelectorContainer').classList.remove('hidden');
            }
        };
        
        // å¼¹ç æ¸¸æˆç±»
        class MarbleGame {
            constructor() {
                this.canvas = document.getElementById('marbleGameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameActive = false;
                this.winText = document.getElementById('winText');
                
                // æ¸¸æˆçŠ¶æ€
                this.marble = {
                    x: 0, y: 0,
                    radius: 15,
                    velocity: { x: 0, y: 0 },
                    launched: false
                };
                
                this.holes = []; // ç›®æ ‡æ´
                this.obstacles = []; // éšœç¢ç‰©
                this.currentLevel = 1;
                this.dragStart = { x: 0, y: 0 };
                this.isDragging = false;
                
                // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
                this.onMouseDown = this.onMouseDown.bind(this);
                this.onMouseMove = this.onMouseMove.bind(this);
                this.onMouseUp = this.onMouseUp.bind(this);
                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchMove = this.onTouchMove.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);
            }
            
            // åˆå§‹åŒ–æ¸¸æˆ
            start() {
                this.gameActive = true;
                
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                this.canvas.width = this.canvas.parentElement.clientWidth;
                this.canvas.height = this.canvas.parentElement.clientHeight;
                
                // åˆå§‹åŒ–ç¬¬ä¸€å…³
                this.setupLevel(this.currentLevel);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                this.canvas.addEventListener('mousedown', this.onMouseDown);
                this.canvas.addEventListener('mousemove', this.onMouseMove);
                this.canvas.addEventListener('mouseup', this.onMouseUp);
                this.canvas.addEventListener('touchstart', this.onTouchStart);
                this.canvas.addEventListener('touchmove', this.onTouchMove);
                this.canvas.addEventListener('touchend', this.onTouchEnd);
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                this.lastTime = performance.now();
                this.gameLoop();
            }
            
            // åœæ­¢æ¸¸æˆ
            stop() {
                this.gameActive = false;
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                this.canvas.removeEventListener('mousedown', this.onMouseDown);
                this.canvas.removeEventListener('mousemove', this.onMouseMove);
                this.canvas.removeEventListener('mouseup', this.onMouseUp);
                this.canvas.removeEventListener('touchstart', this.onTouchStart);
                this.canvas.removeEventListener('touchmove', this.onTouchMove);
                this.canvas.removeEventListener('touchend', this.onTouchEnd);
            }
            
            // è®¾ç½®å…³å¡
            setupLevel(level) {
                // é‡ç½®å¼¹ç çŠ¶æ€
                this.marble.launched = false;
                this.marble.velocity = { x: 0, y: 0 };
                this.isDragging = false;
                this.winText.style.display = 'none';
                
                // æ¸…ç©ºéšœç¢ç‰©å’Œç›®æ ‡
                this.holes = [];
                this.obstacles = [];
                
                // æ ¹æ®å…³å¡è®¾ç½®æ¸¸æˆå…ƒç´ 
                switch (level) {
                    case 1:
                        this.marble.x = 50;
                        this.marble.y = this.canvas.height - 50;
                        
                        // æ·»åŠ ç›®æ ‡æ´
                        this.holes.push({
                            x: this.canvas.width - 50,
                            y: 50,
                            radius: 20
                        });
                        
                        // æ·»åŠ éšœç¢ç‰©
                        this.obstacles.push({
                            x: this.canvas.width / 2 - 100,
                            y: this.canvas.height / 2,
                            width: 200,
                            height: 20
                        });
                        break;
                        
                    case 2:
                        this.marble.x = 50;
                        this.marble.y = 50;
                        
                        // æ·»åŠ ç›®æ ‡æ´
                        this.holes.push({
                            x: this.canvas.width - 50,
                            y: this.canvas.height - 50,
                            radius: 20
                        });
                        
                        // æ·»åŠ éšœç¢ç‰©
                        this.obstacles.push({
                            x: 0,
                            y: this.canvas.height / 2,
                            width: this.canvas.width - 100,
                            height: 20
                        });
                        
                        this.obstacles.push({
                            x: 150,
                            y: this.canvas.height / 4,
                            width: this.canvas.width - 150,
                            height: 20
                        });
                        break;
                        
                    case 3:
                        this.marble.x = this.canvas.width / 2;
                        this.marble.y = this.canvas.height - 50;
                        
                        // æ·»åŠ ç›®æ ‡æ´
                        this.holes.push({
                            x: this.canvas.width / 2,
                            y: 50,
                            radius: 20
                        });
                        
                        // æ·»åŠ éšœç¢ç‰©
                        this.obstacles.push({
                            x: this.canvas.width / 4,
                            y: this.canvas.height / 2,
                            width: 20,
                            height: this.canvas.height / 2
                        });
                        
                        this.obstacles.push({
                            x: this.canvas.width * 3/4,
                            y: 0,
                            width: 20,
                            height: this.canvas.height / 2
                        });
                        
                        this.obstacles.push({
                            x: 0,
                            y: this.canvas.height / 4,
                            width: this.canvas.width / 2,
                            height: 20
                        });
                        break;
                }
            }
            
            // æ¸¸æˆå¾ªç¯
            gameLoop(timestamp) {
                if (!this.gameActive) return;
                
                const deltaTime = timestamp - this.lastTime;
                this.lastTime = timestamp;
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                this.update(deltaTime);
                
                // æ¸²æŸ“æ¸¸æˆ
                this.render();
                
                // ç»§ç»­å¾ªç¯
                requestAnimationFrame(this.gameLoop.bind(this));
            }
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            update(deltaTime) {
                if (!this.marble.launched) return;
                
                // åº”ç”¨é‡åŠ›
                this.marble.velocity.y += 0.2;
                
                // æ›´æ–°å¼¹ç ä½ç½®
                this.marble.x += this.marble.velocity.x;
                this.marble.y += this.marble.velocity.y;
                
                // æ£€æŸ¥å¢™å£ç¢°æ’
                if (this.marble.x - this.marble.radius < 0 || 
                    this.marble.x + this.marble.radius > this.canvas.width) {
                    this.marble.velocity.x *= -0.8; // åå¼¹å¹¶å‡å°‘èƒ½é‡
                    
                    // ä¿®æ­£ä½ç½®é˜²æ­¢å¡åœ¨å¢™å†…
                    if (this.marble.x - this.marble.radius < 0) {
                        this.marble.x = this.marble.radius;
                    }
                    if (this.marble.x + this.marble.radius > this.canvas.width) {
                        this.marble.x = this.canvas.width - this.marble.radius;
                    }
                }
                
                if (this.marble.y - this.marble.radius < 0 || 
                    this.marble.y + this.marble.radius > this.canvas.height) {
                    this.marble.velocity.y *= -0.8; // åå¼¹å¹¶å‡å°‘èƒ½é‡
                    
                    // ä¿®æ­£ä½ç½®é˜²æ­¢å¡åœ¨å¢™å†…
                    if (this.marble.y - this.marble.radius < 0) {
                        this.marble.y = this.marble.radius;
                    }
                    if (this.marble.y + this.marble.radius > this.canvas.height) {
                        this.marble.y = this.canvas.height - this.marble.radius;
                    }
                }
                
                // æ£€æŸ¥éšœç¢ç‰©ç¢°æ’
                for (const obstacle of this.obstacles) {
                    // è®¡ç®—å¼¹ç ä¸çŸ©å½¢çš„æœ€è¿‘ç‚¹
                    const closestX = Math.max(obstacle.x, Math.min(this.marble.x, obstacle.x + obstacle.width));
                    const closestY = Math.max(obstacle.y, Math.min(this.marble.y, obstacle.y + obstacle.height));
                    
                    // è®¡ç®—è·ç¦»
                    const distanceX = this.marble.x - closestX;
                    const distanceY = this.marble.y - closestY;
                    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
                    
                    if (distance < this.marble.radius) {
                        // ç¢°æ’å“åº”
                        const normalX = distanceX / distance;
                        const normalY = distanceY / distance;
                        
                        // è®¡ç®—é€Ÿåº¦åœ¨æ³•çº¿æ–¹å‘çš„åˆ†é‡
                        const dotProduct = this.marble.velocity.x * normalX + this.marble.velocity.y * normalY;
                        
                        // åå¼¹é€Ÿåº¦
                        this.marble.velocity.x -= 2 * dotProduct * normalX * 0.8;
                        this.marble.velocity.y -= 2 * dotProduct * normalY * 0.8;
                        
                        // è½»å¾®ç§»åŠ¨å¼¹ç ä»¥é¿å…å¡åœ¨éšœç¢ç‰©ä¸­
                        this.marble.x += normalX * (this.marble.radius - distance + 1);
                        this.marble.y += normalY * (this.marble.radius - distance + 1);
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦è¿›æ´
                for (const hole of this.holes) {
                    const dx = this.marble.x - hole.x;
                    const dy = this.marble.y - hole.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < hole.radius) {
                        // ç©å®¶å®Œæˆæœ¬å…³
                        this.completeLevel();
                        break;
                    }
                }
                
                // é€æ¸å‡å°‘é€Ÿåº¦ï¼ˆæ¨¡æ‹Ÿæ‘©æ“¦ï¼‰
                this.marble.velocity.x *= 0.99;
                this.marble.velocity.y *= 0.99;
                
                // å¦‚æœé€Ÿåº¦éå¸¸å°ï¼Œåœæ­¢ç§»åŠ¨
                if (Math.abs(this.marble.velocity.x) < 0.1 && Math.abs(this.marble.velocity.y) < 0.1 &&
                    this.marble.launched) {
                    this.marble.velocity.x = 0;
                    this.marble.velocity.y = 0;
                    
                    // å…è®¸é‡æ–°å‘å°„
                    if (this.marble.launched) {
                        this.isDragging = true;
                        this.dragStart.x = this.marble.x;
                        this.dragStart.y = this.marble.y;
                    }
                }
            }
            
            // æ¸²æŸ“æ¸¸æˆ
            render() {
                // æ¸…é™¤ç”»å¸ƒ
                this.ctx.fillStyle = '#7cbf6d';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶ç›®æ ‡æ´
                for (const hole of this.holes) {
                    this.ctx.fillStyle = 'black';
                    this.ctx.beginPath();
                    this.ctx.arc(hole.x, hole.y, hole.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                // ç»˜åˆ¶éšœç¢ç‰©
                this.ctx.fillStyle = '#5a9f5e';
                for (const obstacle of this.obstacles) {
                    this.ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                }
                
                // ç»˜åˆ¶å¼¹ç 
                this.ctx.fillStyle = 'white';
                this.ctx.beginPath();
                this.ctx.arc(this.marble.x, this.marble.y, this.marble.radius, 0, Math.PI * 2);
                this.ctx.fill();
                
                // å¦‚æœæ­£åœ¨æ‹–åŠ¨ï¼Œç»˜åˆ¶æ‹–åŠ¨çº¿
                if (this.isDragging) {
                    this.ctx.strokeStyle = 'rgba(255,255,255,0.7)';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.marble.x, this.marble.y);
                    
                    // è®¡ç®—åŠ›é‡æ–¹å‘
                    const dx = this.marble.x - this.dragStart.x;
                    const dy = this.marble.y - this.dragStart.y;
                    // é™åˆ¶æœ€å¤§æ‹–åŠ¨é•¿åº¦
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const maxLength = 100;
                    const scale = length > maxLength ? maxLength / length : 1;
                    
                    const endX = this.marble.x - dx * scale;
                    const endY = this.marble.y - dy * scale;
                    
                    this.ctx.lineTo(endX, endY);
                    this.ctx.stroke();
                    
                    // ç»˜åˆ¶åŠ›é‡æŒ‡ç¤ºå™¨
                    const power = Math.min(length / maxLength, 1);
                    this.ctx.fillStyle = `rgba(255, ${255 - power * 255}, 0, 0.7)`;
                    this.ctx.beginPath();
                    this.ctx.arc(endX, endY, 5 + power * 5, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                // æ˜¾ç¤ºå…³å¡ä¿¡æ¯
                this.ctx.fillStyle = 'white';
                this.ctx.font = '20px Arial';
                this.ctx.textAlign = 'left';
                this.ctx.fillText(`å…³å¡: ${this.currentLevel}/3`, 10, 30);
            }
            
            // å®Œæˆå…³å¡
            completeLevel() {
                // åœæ­¢å¼¹ç è¿åŠ¨
                this.marble.velocity = { x: 0, y: 0 };
                this.marble.launched = false;
                
                if (this.currentLevel < 3) {
                    // å‰è¿›åˆ°ä¸‹ä¸€å…³
                    this.currentLevel++;
                    Helpers.showMessage(`æ­å–œ! è¿›å…¥ç¬¬${this.currentLevel}å…³`, 'success');
                    this.setupLevel(this.currentLevel);
                } else {
                    // æ¸¸æˆèƒœåˆ©
                    this.winText.style.display = 'block';
                    Helpers.showMessage('æ­å–œ! æ‚¨å®Œæˆäº†æ‰€æœ‰å…³å¡!', 'success');
                    
                    // 3ç§’åé‡æ–°å¼€å§‹æ¸¸æˆ
                    setTimeout(() => {
                        this.currentLevel = 1;
                        this.setupLevel(this.currentLevel);
                    }, 3000);
                }
            }
            
            // äº‹ä»¶å¤„ç†å™¨
            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨å¼¹ç ä¸Š
                const dx = mouseX - this.marble.x;
                const dy = mouseY - this.marble.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= this.marble.radius * 1.5) {
                    this.isDragging = true;
                    this.dragStart.x = mouseX;
                    this.dragStart.y = mouseY;
                }
            }
            
            onMouseMove(e) {
                if (!this.isDragging) return;
                
                const rect = this.canvas.getBoundingClientRect();
                this.dragStart.x = e.clientX - rect.left;
                this.dragStart.y = e.clientY - rect.top;
            }
            
            onMouseUp() {
                if (this.isDragging) {
                    this.launch();
                }
            }
            
            // è§¦æ‘¸äº‹ä»¶å¤„ç†
            onTouchStart(e) {
                if (e.touches.length !== 1) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const touchX = e.touches[0].clientX - rect.left;
                const touchY = e.touches[0].clientY - rect.top;
                
                // æ£€æŸ¥æ˜¯å¦è§¦æ‘¸åœ¨å¼¹ç ä¸Š
                const dx = touchX - this.marble.x;
                const dy = touchY - this.marble.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= this.marble.radius * 2) { // åœ¨è§¦æ‘¸å±ä¸Šç»™äºˆæ›´å¤§çš„è§¦æ‘¸åŒºåŸŸ
                    this.isDragging = true;
                    this.drag
